<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/admin">Admin Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Lớp <%= classAccount.username %></li>
                </ol>
            </nav>
            <div class="card bg-primary text-white border-0 shadow-sm rounded-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="fw-bold mb-1"><i class="bi bi-people-fill me-2"></i>Lớp <%= classAccount.username %></h2>
                            <p class="mb-0 opacity-75"><i class="bi bi-person-badge me-1"></i>GVCN: <%= classAccount.teacherName %></p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-primary fs-6 px-3 py-2 rounded-pill mb-2 d-block">
                                <i class="bi bi-person-check me-1"></i><%= students.length %> học sinh
                            </span>
                            <span class="badge bg-light text-primary fs-6 px-3 py-2 rounded-pill d-block">
                                <i class="bi bi-egg-fried me-1"></i><%= foodItems.length %> món ăn
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs nav-fill mb-4" id="classTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-semibold" id="bank-tab" data-bs-toggle="tab" data-bs-target="#bank" type="button">
                <i class="bi bi-bank me-2"></i>Thông tin tài khoản
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button">
                <i class="bi bi-people me-2"></i>Danh sách học sinh
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-semibold" id="food-tab" data-bs-toggle="tab" data-bs-target="#food" type="button">
                <i class="bi bi-egg-fried me-2"></i>Danh sách món ăn
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="classTabsContent">
        
        <!-- 1. Bank Information Tab -->
        <div class="tab-pane fade show active" id="bank" role="tabpanel">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-4">
                    <% if (representative) { %>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5 class="fw-bold text-primary mb-3">Thông tin đại diện</h5>
                                <div class="mb-3">
                                    <label class="text-muted small">Tên đại diện</label>
                                    <p class="fw-semibold fs-5"><%= representative.representativeName %></p>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="fw-bold text-primary mb-3">Danh sách tài khoản ngân hàng</h5>
                        <% if (representative.accounts && representative.accounts.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle border rounded-3">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-3">Ngân hàng</th>
                                            <th>Số tài khoản</th>
                                            <th>Chủ tài khoản</th>
                                            <th class="text-center">Loại tài khoản</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% representative.accounts.forEach(acc => { %>
                                        <tr>
                                            <td class="ps-3 fw-semibold text-primary"><%= acc.bankName %></td>
                                            <td><code class="fs-6"><%= acc.accountNumber %></code></td>
                                            <td class="fw-semibold"><%= acc.accountHolder %></td>
                                            <td class="text-center">
                                                <% if (acc.isMain) { %>
                                                    <span class="badge bg-success rounded-pill">Chính</span>
                                                <% } else { %>
                                                    <span class="badge bg-secondary rounded-pill">Phụ</span>
                                                <% } %>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="alert alert-warning">Chưa có tài khoản ngân hàng nào được đăng ký.</div>
                        <% } %>
                        
                        <div class="mt-4 pt-3 border-top">
                            <form action="/admin/delete-rep/<%= classAccount.username %>" method="POST" onsubmit="return confirm('Bạn có chắc muốn xóa toàn bộ thông tin tài chính của lớp này?');">
                                <button type="submit" class="btn btn-outline-danger rounded-3">
                                    <i class="bi bi-trash me-2"></i>Xóa thông tin tài chính
                                </button>
                            </form>
                        </div>
                    <% } else { %>
                        <div class="text-center py-5">
                            <i class="bi bi-bank text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">Lớp này chưa đăng ký thông tin tài chính.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- 2. Students Tab -->
        <div class="tab-pane fade" id="students" role="tabpanel">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-0">
                    <% if (students.length === 0) { %>
                        <div class="text-center py-5">
                            <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">Chưa có học sinh nào đăng ký mở tài khoản.</p>
                        </div>
                    <% } else { %>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">Họ và tên</th>
                                        <th>Ngày sinh</th>
                                        <th>Số CCCD</th>
                                        <th>Số điện thoại</th>
                                        <th>Ảnh CCCD</th>
                                        <th class="text-center">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% students.forEach(student => { %>
                                    <tr style="cursor: pointer;" onclick="showStudentDetail(<%= JSON.stringify(student) %>)">
                                        <td class="ps-4 fw-semibold"><%= student.fullName %></td>
                                        <td><%= new Date(student.dob).toLocaleDateString('vi-VN') %></td>
                                        <td><code><%= student.cccdNumber %></code></td>
                                        <td><%= student.phoneNumber %></td>
                                        <td>
                                            <% if (student.cccdFront || student.cccdBack) { %>
                                            <span class="badge bg-success rounded-pill">
                                                <i class="bi bi-check-circle me-1"></i>
                                                <%= (student.cccdFront ? 1 : 0) + (student.cccdBack ? 1 : 0) %> ảnh
                                            </span>
                                            <% } else { %>
                                            <span class="badge bg-secondary rounded-pill">Không có</span>
                                            <% } %>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-outline-info btn-sm rounded-pill me-1" onclick="event.stopPropagation(); showStudentDetail(<%= JSON.stringify(student) %>);" title="Xem chi tiết">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <form action="/admin/delete-student/<%= student.id %>" method="POST" class="d-inline" onsubmit="event.stopPropagation(); return confirm('Bạn có chắc muốn xóa học sinh <%= student.fullName %>?');">
                                                <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill" title="Xóa học sinh">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- 3. Food Menu Tab -->
        <div class="tab-pane fade" id="food" role="tabpanel">
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-body p-0">
                    <% if (foodItems.length === 0) { %>
                        <div class="text-center py-5">
                            <i class="bi bi-egg-fried text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">Lớp này chưa đăng ký món ăn nào.</p>
                        </div>
                    <% } else { %>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">STT</th>
                                        <th>Tên món ăn</th>
                                        <th>Giá bán</th>
                                        <th>Mô tả</th>
                                        <th class="text-center">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% foodItems.forEach((item, index) => { %>
                                    <tr>
                                        <td class="ps-4 text-muted"><%= index + 1 %></td>
                                        <td class="fw-semibold"><%= item.name %></td>
                                        <td><span class="badge bg-success rounded-pill fs-6"><%= item.price.toLocaleString('vi-VN') %> đ</span></td>
                                        <td>
                                            <% if (item.description) { %>
                                                <%= item.description %>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                            <% } %>
                                        </td>
                                        <td class="text-center">
                                            <form action="/delete-food/<%= item.id %>" method="POST" class="d-inline" onsubmit="return confirm('Bạn có chắc muốn xóa món <%= item.name %>?');">
                                                <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill" title="Xóa món ăn">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Detail Modal (Reused) -->
<div class="modal fade" id="studentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-person-badge me-2 text-primary"></i>Thông tin học sinh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small">Họ và tên</label>
                            <p class="fw-semibold fs-5 mb-0" id="detailFullName">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Lớp</label>
                            <p class="mb-0"><span class="badge bg-primary rounded-pill" id="detailClass">-</span></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Ngày sinh</label>
                            <p class="fw-semibold mb-0" id="detailDob">-</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small">Số CCCD</label>
                            <p class="mb-0"><code class="fs-5" id="detailCccd">-</code></p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Số điện thoại</label>
                            <p class="fw-semibold mb-0" id="detailPhone">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Ngày đăng ký</label>
                            <p class="mb-0" id="detailCreatedAt">-</p>
                        </div>
                    </div>
                </div>
                
                <hr>
                <h6 class="fw-bold mb-3"><i class="bi bi-images me-2"></i>Ảnh CCCD</h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card bg-light border-0 rounded-3 h-100">
                            <div class="card-body text-center p-3">
                                <p class="text-muted small mb-2">Mặt trước</p>
                                <div id="detailCccdFront">
                                    <span class="text-muted">Chưa có ảnh</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light border-0 rounded-3 h-100">
                            <div class="card-body text-center p-3">
                                <p class="text-muted small mb-2">Mặt sau</p>
                                <div id="detailCccdBack">
                                    <span class="text-muted">Chưa có ảnh</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Image Modal -->
<div class="modal fade" id="fullImageModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="fullImageTitle">Ảnh CCCD</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <img src="" alt="CCCD Full" id="fullImageSrc" class="img-fluid rounded-3" style="max-height: 80vh;">
            </div>
        </div>
    </div>
</div>

<script>
// Show student detail modal
function showStudentDetail(student) {
    document.getElementById('detailFullName').textContent = student.fullName;
    document.getElementById('detailClass').textContent = student.className;
    document.getElementById('detailDob').textContent = new Date(student.dob).toLocaleDateString('vi-VN');
    document.getElementById('detailCccd').textContent = student.cccdNumber;
    document.getElementById('detailPhone').textContent = student.phoneNumber;
    document.getElementById('detailCreatedAt').textContent = new Date(student.createdAt).toLocaleDateString('vi-VN');
    
    // CCCD Front
    const frontDiv = document.getElementById('detailCccdFront');
    if (student.cccdFront) {
        frontDiv.innerHTML = `<img src="${student.cccdFront}" class="img-fluid rounded-3" style="max-height: 200px; cursor: pointer;" onclick="showFullImage('${student.cccdFront}', 'Mặt trước - ${student.fullName}')">`;
    } else {
        frontDiv.innerHTML = '<span class="text-muted"><i class="bi bi-image me-1"></i>Chưa có ảnh</span>';
    }
    
    // CCCD Back
    const backDiv = document.getElementById('detailCccdBack');
    if (student.cccdBack) {
        backDiv.innerHTML = `<img src="${student.cccdBack}" class="img-fluid rounded-3" style="max-height: 200px; cursor: pointer;" onclick="showFullImage('${student.cccdBack}', 'Mặt sau - ${student.fullName}')">`;
    } else {
        backDiv.innerHTML = '<span class="text-muted"><i class="bi bi-image me-1"></i>Chưa có ảnh</span>';
    }
    
    new bootstrap.Modal(document.getElementById('studentDetailModal')).show();
}

// Show full image
function showFullImage(src, title) {
    document.getElementById('fullImageSrc').src = src;
    document.getElementById('fullImageTitle').textContent = title;
    bootstrap.Modal.getInstance(document.getElementById('studentDetailModal')).hide();
    new bootstrap.Modal(document.getElementById('fullImageModal')).show();
}
</script>
